var g_view="html",g_focusmode_switch=!1,g_preview_on=!0,g_selectedTextarea=null,g_echange_on=!1;function g_domSetHighlightedContent(e,t,a){var i=document.getElementById(e),r=null;return"none"===a?i.innerHTML=t:window.hljs?(r=window.hljs.highlight(a,t),i.innerHTML=r.value):i.textContent=t,r}function g_domFindScrollMarks(){for(var e,t=document.querySelectorAll("#article_main .line"),a=[],i=[0],r=[0],n=0,l=t.length;n<l;n++)(e=parseInt(t[n].getAttribute("data-line")))&&(a[e]=Math.round(t[n].offsetTop));var o=document.querySelectorAll(".ldt-pre .block-start");for(l=o.length,e=0,n=0;n<l;n++){var s=parseInt(o[n].getAttribute("data-line"));s&&void 0!==a[e+=s]&&(i.push(o[n].offsetTop),r.push(a[e]))}var c=document.querySelector(".ldt-pre").scrollHeight,d=i[i.length-1];return i.push(c-5>d?c-5:d),r.push(document.querySelector("#article_main").scrollHeight),[i,r]}!function(e,t){"use strict";var a=g_domFindScrollMarks,i=e.getElementById("title-source"),r=(e.getElementById("article_title"),e.getElementById("abstact-source")),n=(e.getElementById("article_abstract_text"),e.getElementById("main-source")),l=e.getElementById("article_main"),o=e.querySelector('meta[name="article_id"]').content,s=debounce(function(){h.recalcHeight()},100),c=new ScrollMap(a),d=new ImagePreloader,u=new ImageLoader(d,"https:"===location.protocol?"https:":"http:","m_"),m=new ParserCollection(t.markdownit,function(e){c.reset();try{localStorage.setItem("mur2_main_content"+o,e),localStorage.setItem("mur2_main_content"+o+"_time",+new Date)}catch(e){}},"article_main","article_main_pre",function(){return n.value},u),g=new ImageLoader(new ImagePreloader,"https:"===location.protocol?"https:":"http:","t_"),p=new ParserCollection(t.markdownit,function(e){try{localStorage.setItem("mur2_title_content"+o,e.split("\n").slice(2,-3).join("\n")),localStorage.setItem("mur2_title_content"+o+"_time",+new Date)}catch(e){}},"article_title","article_title",function(){return'<span id="article_title">\n\n'+i.value.replace(/(?:\r\n|\r|\n)/g,"")+"\n\n</span>\n"},g),f=new ImageLoader(new ImagePreloader,"https:"===location.protocol?"https:":"http:","a_"),v=new ParserCollection(t.markdownit,function(e){try{localStorage.setItem("mur2_abstract_content"+o,e.split("\n").slice(2,-3).join("\n")),localStorage.setItem("mur2_abstract_content"+o+"_time",+new Date)}catch(e){}},"article_abstract_text","article_abstract_text",function(){return'<span id="article_abstract">\n\n'+r.value+"\n\n</span>\n"},f);m.updateResult(u,!0),v.updateResult(f,!0),p.updateResult(g,!0),collapsible_listener();var h=new TextareaDecorator(n,mdParser),b=e.getElementsByClassName("ldt")[0],y=new SyncScroll(c,new Animator(function(){return b.scrollTop},function(e){b.scrollTop=e}),new Animator(function(){return l.scrollTop},function(e){l.scrollTop=e}),b,l,e.querySelector('[id^="maintext"]')),w=debounce(m.updateResult,300,{maxWait:3e3}),E=debounce(p.updateResult,300,{maxWait:3e3}),L=debounce(v.updateResult,300,{maxWait:3e3});let I=e.querySelector("#article_input_side");["input","conv"].forEach(e=>I.addEventListener(e,e=>{var t;t="input"==e.type?e.target.id:e.detail;var a=g_preview_on;switch(g_selectedTextarea=t,t){case"title-source":a&&E(g,!1);break;case"abstact-source":a&&L(f,!1);break;case"main-source":a&&w(u,!1)}})),n.addEventListener("touchstart",y.switchScrollToSrc),n.addEventListener("mouseover",y.switchScrollToSrc),l.addEventListener("touchstart",y.switchScrollToResult),l.addEventListener("mouseover",y.switchScrollToResult),y.switchScrollToSrc(),function(){var a,i=e.querySelector("#slider"),r=new Draggabilly(i,{axis:"x"}),n=e.getElementById("article_input_side"),l=e.getElementById("article_preview_side");function o(e){n.style.width="calc("+e+"% - 3px)",l.style.width="calc("+(100-e)+"% - 3px)",c.reset(),s()}i.addEventListener("dblclick",function(){o(50)}),r.on("dragStart",function(e,i,r){a=t.innerWidth}),r.on("dragMove",function(e,t,i){o(100*t.pageX/a)})}(),t.addEventListener("resize",function(){c.reset(),s()});for(var B=["select","click"],k=B.length;k--;)I.addEventListener(B[k],e=>{let t=e.target;"title-source"!==t.id&&"abstact-source"!==t.id&&"main-source"!==t.id||(g_selectedTextarea=t.id,g_focusmode_switch&&h.update())});var T=new Event("input");function S(){var e=g_selectedTextarea;"main-source"===e?(w(u,!1),n.dispatchEvent(T)):"title-source"===e?E(g,!1):"abstact-source"===e&&L(f,!1)}e.getElementById("fileElem").addEventListener("change",function(){if(this.files&&FileReader){var t=new FileReader,a=this;t.onload=function(){var t=this.result,l=e.createElement("div");l.innerHTML=t;var o=e.createDocumentFragment();o.appendChild(l);var s=o.getElementById("article_title"),c=o.getElementById("article_abstract");r.value=c.innerHTML,i.value=s.innerHTML.replace("\n",""),s.parentNode.removeChild(s),c.parentNode.removeChild(c),n.value=o.textContent.replace(/^\s+/g,""),w(u,!0),n.dispatchEvent(T),h.update(),a.value=a.defaultValue,o=null,E(g,!0),L(f,!0)},t.readAsText(this.files[0])}}),e.getElementById("feaImg_add").addEventListener("change",function(){if(this.files&&FileReader){var a=e.getElementById("feaImg_add").files[0],i=new FileReader;i.onload=function(){var a=e.getElementById("article_abstract_div").firstElementChild;a.src=i.result,a.classList.remove("hide"),localStorage.setItem("mur2_featured_image"+o,a.src);const r=(new t.Date).getUTCDate();localStorage.setItem("mur2_featured_image"+o+"_time",+r)},i.readAsDataURL(a)}}),e.querySelector("#id_featureImage").addEventListener("click",function(){if("feaImg_del"==event.target.id){var t=e.getElementById("article_abstract_div").firstElementChild;t.src="",t.classList.add("hide"),localStorage.setItem("mur2_featured_image"+o,t.src),localStorage.setItem("mur2_featured_image"+o+"_time",+new Date)}}),e.getElementById("pictureElem").addEventListener("change",function(){if(this.files&&FileReader){var t=new FileReader;t.onload=function(){e.getElementById("msg");var t=200;if(["jpg","jpeg","png","gif"].includes(i)){var r=new Blob([this.result],{type:"imgage/"+i}),n=new FormData;n.append("photo",r,a),n.append("mediapage",!1);var l=new XMLHttpRequest;l.open("post","/media",!0),l.send(n),l.onload=function(){if(200!=l.status)alert(_("Error: ")+l.statusText+" - "+l.response),t=l.status;else{var e=JSON.parse(l.response);editorToolbarAction("picture",e.url),S()}}}else t=400,alert(_("Error: ")+_("Not supported image format!"));msgclear(t)},t.readAsArrayBuffer(this.files[0]);var a=this.files[0].name,i=this.files[0].name.split(".").pop().toLowerCase()}}),e.getElementById("bibliography").addEventListener("change",function(){if(this.files&&FileReader){var t=new FileReader;t.onload=function(){e.getElementById("msg");var t=200;if(["bib"].includes(a)){var i=new Blob([this.result],{type:"text/plain"}),r=new FormData;r.append("bibliography",i,"bibliography.bib");var n=new XMLHttpRequest;n.open("post","/bibliography",!0),n.send(r),n.onload=function(){if(200!=n.status)alert(_("Error: ")+n.statusText+" - "+n.response),t=n.status;else{var a=JSON.parse(n.response);console.log(a);var i=e.getElementById("main-source");i.value=i.value+"\n"+a.bib,S()}}}else alert(_("Error: ")+_("Not supported file format!")),t=400;msgclear(t)},t.readAsArrayBuffer(this.files[0]);var a=this.files[0].name.split(".").pop().toLowerCase()}}),e.querySelector("#menu").addEventListener("click",a=>{let i=a.target;if(i.classList.contains("choice_menu")){var r=i.id.replace("id_",""),l=e.getElementById("menu");l.classList.contains(r)?l.classList.remove(r):l.classList.add(r)}else if(i.classList.contains("choice_toolbar"))switch(i.id){case"id_upload":upload_source();break;case"id_download":download_result([m,v,p]);break;case"id_save":w(u,!0),E(g,!0),L(f,!0),save_article([m,v,p]);break;case"id_syntax_hl":var o=e.getElementById("id_syntax_hl");g_focusmode_switch?(o.classList.add("focusmode"),g_focusmode_switch=!1):(o.classList.remove("focusmode"),g_focusmode_switch=!0),n.dispatchEvent(T);break;case"id_hide_preview":var s=e.getElementById("article_preview_side"),c=e.getElementById("article_input_side");o=e.getElementById("id_hide_preview");s.classList.contains("previewoff")?(s.classList.remove("previewoff"),c.classList.remove("previewoff"),o.classList.remove("previewoff"),g_preview_on=!0,w(u,!0),E(g,!0),L(f,!0)):(s.classList.add("previewoff"),c.classList.add("previewoff"),o.classList.add("previewoff"),g_preview_on=!1);break;case"id_hide_input":s=e.getElementById("article_preview_side"),c=e.getElementById("article_input_side"),o=e.getElementById("id_hide_input");c.classList.contains("inputoff")?(s.classList.remove("inputoff"),c.classList.remove("inputoff"),o.classList.remove("inputoff")):(s.classList.add("inputoff"),c.classList.add("inputoff"),o.classList.add("inputoff"));break;case"id_show_title":for(var d=e.querySelectorAll("#article_preview_side, #article_input_side"),h=(o=e.getElementById("id_show_title"),d.length);h--;)d[h].classList.contains("titleon")?(d[h].classList.remove("titleon"),o.classList.remove("titleon")):(d[h].classList.add("titleon"),o.classList.add("titleon"));break;case"id_proof":if("main-source"===g_selectedTextarea){var b=e.getElementById(g_selectedTextarea),y=b.selectionStart,I=b.selectionEnd,B=e.getElementById("editorModal"),k=e.getElementById("modalClose");e.getElementsByClassName("modal-body")[0].innerHTML='<iframe id="editor_iframe" allowTransparency="true" frameborder="0" scrolling="yes"  src="/embedding" type= "text/javascript"></iframe>',B.style.display="block",k.onclick=function(){var t=e.getElementById("editor_iframe"),a=t.contentWindow.document.getElementById("selected");if(a.innerHTML.length>0){var i=b.value.substring(y,I);0===i.length&&(i=t.contentWindow.document.getElementById("selected_title").innerHTML);var r=t.contentWindow.document.getElementById("myList").value;b.value=b.value.substring(0,y)+'<button type="button" class="collapsible">'+i+'</button><div class="iframe_wrap"><iframe scrolling="no" relationtype="'+r+'" src="/iframe/'+a.innerHTML+'"></iframe><a href="/reader/'+a.innerHTML+'">'+_("Full text")+"</a></div>"+b.value.substring(I),b.focus(),b.select(),b.selectionStart=I,b.selectionEnd=I,S()}B.style.display="none"},t.onclick=function(e){e.target==B&&(B.style.display="none",b.focus(),b.select(),b.selectionStart=y,b.selectionEnd=I)}}break;case"id_echange":!0!==g_echange_on?(e.getElementById("editor_changes").disabled=!1,g_echange_on=!0,e.getElementById("id_echange_botton").style.color="#c62641"):(e.getElementById("editor_changes").disabled=!0,g_echange_on=!1,e.getElementById("id_echange_botton").style.color="white");break;case"id_bib":upload_bib();break;case"id_head":editorToolbarAction("heading"),S();break;case"id_italic":editorToolbarAction("italic"),S();break;case"id_strong":editorToolbarAction("strong"),S();break;case"id_picture":if(console.log(t.location.pathname),"/editor"===t.location.pathname){var x=prompt(_("Please enter a URL for image."),"");null!=x&&(editorToolbarAction("picture",x),S())}else upload_picture();break;case"id_link":editorToolbarAction("link"),S();break;case"id_list":editorToolbarAction("list"),S();break;case"id_nlist":editorToolbarAction("numbered_list"),S();break;case"id_footnote":editorToolbarAction("footnote"),S();break;case"id_table":editorToolbarAction("table"),S();break;case"id_code":editorToolbarAction("code"),S();break;case"id_latex":editorToolbarAction("latex"),S();break;case"id_chat":e.getElementById("id_side_menu").checked=!0,e.getElementById("id_ec").checked=!0,msgnotice("hide")}}),e.addEventListener("keydown",function(e){var t=void 0,a=[e.key,e.keyIdentifier,e.keyCode,e.which];for(;void 0===t&&a.length>0;)t=a.pop();if(t&&("115"==t||"83"==t)&&(e.ctrlKey||e.metaKey)&&!e.altKey)return e.preventDefault(),w(u,!0),E(g,!0),L(f,!0),save_article([m,v,p]),!1;return!0}),e.querySelector("#side_menu").addEventListener("click",a=>{let i=a.target;if(i.classList.contains("preview-format")){for(var r=i.id.replace("id_",""),n=e.body,l=n.className.split(" "),o=null,s=l.length;s--;)/result-as-*/.test(l[s])&&(o=l[s]);n.classList.remove(o),n.classList.add("result-as-"+r),g_view=r,E(g,!0),L(f,!0),w(u,!0)}else if("id_wpc_publish"===i.id)wordpress_on_fly(p,v,m);else if("id_medium_publish"===i.id)medium_on_fly(p,v,m);else if("id_medium_connect"===i.id)medium_connect();else if("id_rollback_article"===i.id)getArticleversion(),w(u,!0),E(g,!1),L(f,!1);else if("id_wpc_clear"===i.id)clear_cookies("wpc");else if("id_medium_clear"===i.id)clear_cookies("medium");else if("id_pdf"===i.id)generate_from_md("pdf",m);else if("id_latex_export"===i.id)generate_from_md("latex",m);else if("id_epub"===i.id)generate_from_md("epub",m);else if("id_msw"===i.id)generate_from_md("msw",m);else if("id_publish_article"===i.id){e.getElementById("transFrame").addEventListener("load",function(){t.location.reload(!0)})}})}(document,window);