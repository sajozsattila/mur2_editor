var collaboratidomain,collaboratchannel,chatpossition;function loadhistory(){var e=chatpossition-25;e<1&&(limit=25+e,e=0),collaboratchannel.getHistory({startEvent:e,limit:25,eventFilter:["message"],forward:!0}).then(t=>{if(t.data.length>0){eventnumbers=[];var n=document.getElementById("chatposts");t.data.slice().reverse().forEach(e=>{if(e.eventNumber<chatpossition){eventnumbers.push(e.eventNumber);var t=document.createElement("li"),a=document.createElement("span");a.className+="chatuser",a.innerText=e.user.username,t.appendChild(a);var i=document.createElement("p");i.innerText=e.message.split(":").slice(1).join(":"),t.appendChild(i),n.insertBefore(t,n.firstChild)}}),eventnumbers.length>0&&(chatpossition=Math.min.apply(null,eventnumbers)),0===e&&(document.getElementById("chathistory").style.display="none")}})}function msgnotice(e){var t=document.getElementById("editorchat");if(null!==t){var n=document.getElementById("chatsign");"none"===window.getComputedStyle(t,null).display&&"hide"!==e?n.style.visibility="visible":n.style.visibility="hidden"}}function collaborative(e,t,n){if(parseInt(n)>0){var a="https://mur2.co.uk:9000/api/realtime/convergence/default";function i(e){const t=e.elementAt("text"),n=document.getElementById("main-source");return ConvergenceInputElementBinder.bindTextInput(n,t),e}function o(e){var t=document.getElementById("main-source"),n=new CustomEvent("conv",{detail:"main-source"}),a=new Event("input"),i=document.querySelector("#article_input_side");e.events().subscribe(e=>{switch(e.name){case"version_changed":t.dispatchEvent(a),i.dispatchEvent(n)}})}function s(e){"showmsg"in e?msgnotice(e.showmsg):msgnotice();var t=document.createElement("li"),n=document.createElement("span");n.className+="chatuser",n.innerText=e.user,t.appendChild(n);var a=document.createElement("p");a.innerText=e.msg,t.appendChild(a),document.getElementById("chatposts").appendChild(t)}async function c(e){return e.create({id:"articles"+n,type:"channel",name:"articles"+n,topic:"Chat about Article"+n,membership:"public",ignoreExistsError:!0}).then(t=>e.join(t)).then(e=>e)}Convergence.connectWithJwt(a,e).catch(t=>{Convergence.connectWithJwt(a,e)}).then(function(e){return e.models().openAutoCreate({collection:t,id:n,data:{text:document.getElementById("main-source").value}}).then(i).then(o).catch(e=>{console.log("Could not open model: "+e)}),e}).then(function(e){this.domain=e;const t=e.chat();t.joined().then(e=>{var a=!0;for(let t=0;t<e.length;t++)if(e[t].chatId==="articles"+n){a=!1;break}return a?c(t).then(e=>e):t.get("articles"+n).then(e=>e)}).catch(e=>(channel=c(t).then(e=>e),channel)).then(e=>(console.log(t),this.channel=e,e.on("Message",e=>{s({msg:e.message.split(":").slice(1).join(":"),user:e.message.split(":")[0]})}),e)).then(e=>{var t=e.getHistory({limit:10,eventFilter:["message"]}).then(e=>e);return t}).then(e=>{var t=[];e.data.length>0&&e.data.slice().reverse().forEach(e=>{t.push(e.eventNumber),s({msg:e.message.split(":").slice(1).join(":"),user:e.user.username,showmsg:"hide"})}),chatpossition=Math.min.apply(null,t),collaboratchannel=this.channel,collaboratidomain=this.domain})}).catch(e=>{console.log("Could not connect: "+e)})}}function handleMessageSubmission(e,t){if(13===e.keyCode){const e=collaboratidomain.chat();e.joined().then(n=>{var a=!0;for(let e=0;e<n.length;e++)if(n[e].chatId==="articles"+t){a=!1;break}a&&e.join("articles"+t).then()}).then(()=>{collaboratchannel.send(collaboratidomain.session().user().displayName+":"+document.getElementById("chatinput").value)}).then(()=>{document.getElementById("chatinput").value=""})}}