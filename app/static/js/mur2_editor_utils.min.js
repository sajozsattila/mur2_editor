function documentReady(e){"loading"!=document.readyState?e():document.addEventListener("DOMContentLoaded",e)}function upload_source(){var e=document.getElementById("fileElem");(e.onclick||e.click||function(){}).call(e)}function upload_picture(){var e=document.getElementById("pictureElem");(e.onclick||e.click||function(){}).call(e)}function upload_bib(){console.log("start upload");var e=document.getElementById("bibliography_file");console.log(e),(e.onclick||e.click||function(){}).call(e)}async function msgclear(e){var t=document.getElementById("msg");200!=e?await sleep(5e3):await sleep(2e3),t.innerHTML=""}async function download_result(e){for(var t="",n=document.getElementById("title-source").value.replace(/\s/g,"_").toLowerCase(),a=e.length;a--;){t+="\n\n"+e[a].getDisplayedResult()}var r=g_view;if("html"===r||"htmltex"===r||"habr"===r||"src"===r){var o=new Blob([t],{type:"text/html; charset=UTF-8"});(l=document.createElement("a")).href=window.URL.createObjectURL(o),l.download=n+".html",l.style.display="none",document.body.appendChild(l),l.click(),delete l}else{var l;o=new Blob([t],{type:"text/markdown; charset=UTF-8"});(l=document.createElement("a")).href=window.URL.createObjectURL(o),l.download=n+".md",l.style.display="none",document.body.appendChild(l),l.click(),delete l}}function editorToolbarAction(e,t){if(null!==g_selectedTextarea){var n=document.getElementById(g_selectedTextarea),a=n.selectionStart,r=n.selectionEnd,o=n.value.substring(a,r),l="",s="";if(a!==r)l=""===o.slice(0,1).trim()?" ":"",s=""===o.slice(-1).trim()?" ":"";var i=null;if("italic"===e)i="*",wrap2=i;else if("strong"===e)i="**",wrap2=i;else if("heading"===e)i="\n# ",wrap2="\n";else if("code"===e)i="\n```\n",wrap2=i;else if("table"===e)i="\n|  |  |\n|--|--|\n|  |  |\n";else if("latex"===e)i="$$ ",wrap2=" $$";else if("link"===e){var d=prompt(_("Please enter a URL for the link."),"");null!=d&&(i=o?"["+o+"]("+d+")":"[link]("+d+")")}else"picture"===e?i=o?"!["+o+"]("+t+")":"![kep]("+t+")":"list"===e?(re=/\n/g,i="\n- "+o.replace(re,"\n- ")):"numbered_list"===e?(re=/\n/g,i="\n1. "+o.replace(re,"\n1. ")):"footnote"===e&&(i="^["+o+"] ");if(null!==i){var c=0;"italic"===e||"strong"===e||"code"===e||"latex"===e||"heading"===e?(n.value=n.value.substring(0,a)+l+i+o.trim()+wrap2+s+n.value.substring(r),c=a!==r?(i+wrap2).length:i.length):(n.value=n.value.substring(0,a)+l+i+s+n.value.substring(r),c=i.length-o.length),n.focus(),n.select(),n.selectionStart=a!==r?a:a+c,n.selectionEnd="footnote"===e&&a===r?r+c-2:r+c}}else swal(_("No field selected!"))}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function alarming(e,t){var n=document.getElementById("msg");e.onload=function(){if(200!=e.status)swal(_("Error: ")+e.statusText+" - "+e.response);else{n.style.color="green",n.innerHTML=t;var a=JSON.parse(e.response);a.hasOwnProperty("id")&&window.location.replace("/edit/"+a.id)}},200!=e.status?await sleep(5e3):await sleep(2e3),n.innerHTML=""}function keywordlist(){for(var e=[],t=document.getElementById("keywords").getElementsByClassName("multi-search-item"),n=t.length;n--;)e.push(t[n].firstChild.firstChild.data);return e}function categorylist(){for(var e=[],t=document.getElementById("categories").getElementsByClassName("multi-search-item"),n=t.length;n--;)try{e.push(t[n].firstChild.firstChild.data)}catch(e){}return 0===e.length&&e.push("Uncategorized"),e}async function save_article(e){var t=new Blob([document.getElementById("main-source").value],{type:"text/html; charset=UTF-8"}),n=document.getElementById("bib-source").value;try{var a=document.getElementById("article_main").innerHTML,r=new Blob([a],{type:"text/html; charset=UTF-8"}),o=document.getElementById("article_abstract").innerHTML,l=document.getElementById("article_title").innerHTML}catch(e){return void swal(_("You can only save in Preview mode!"))}var s=document.getElementById("textype").value;if(0===s.length&&(s="Article"),"Review"===s){if(reviewed=document.getElementById("reviewdArticle"),0==reviewed.value.length||isNaN(reviewed.value))return void swal(_("Choose the Article which you are reviewing!"));if(standby=document.getElementById("reviewStandby"),0==standby.value.length||isNaN(standby.value))return void swal(_("Need to set the Standby!"));if(standby.value<-100||standby.value>100)return void swal(_("Standby should be between +100 and -100!"));rebel=document.getElementById("reviewRebel").checked}var i=new FormData,d=document.querySelector('meta[name="article_id"]').content,c=document.getElementById("title-source").value,u=document.getElementById("abstact-source").value,m="",p=document.getElementsByClassName("feature_image")[0];const w=new URL(p.baseURI);new URL(p.src).pathname!=w.pathname&&(m=p.src);var g=keywordlist(),v=categorylist(),y=document.getElementById("canonicalUrlText").value;0===y.trim().length&&(y="https://mur2.co.uk/reader/"+d),i.append("file",t),i.append("bib",n),i.append("htmlfile",r,"article_text.html"),i.append("article_title_html",l),i.append("article_abstract_html",o),i.append("article_id",d),i.append("article_title",c),i.append("article_abstract",u),i.append("featuredimages",m),i.append("keywords",g.toString()),i.append("categories",v.toString()),i.append("article_url",y),i.append("article_textype",s),"Review"===s&&(i.append("reviewed",reviewed.value),i.append("standby",standby.value),i.append("rebel",rebel));var h=new XMLHttpRequest;h.open("post","/markdownsave",!0),h.send(i),alarming(h,_("Saved!"))}async function medium_connect(){var e=prompt("Please set the Integration tokens","");setCookie("mur2_medium_accesstoken",e,365),window.location.reload()}async function medium_on_fly(e,t,n){var a=document.getElementById("msg"),r=getCookie("mur2_medium_accesstoken"),o=n.getHtmlImg(),l=e.getHtmlImg().split("\n")[1].slice(3,-4),s=t.getHtmlImg(),i=document.querySelector('meta[name="article_id"]').content,d=keywordlist(),c=new FormData;c.append("acceskey",r),c.append("article_id",i),c.append("article_title",l),c.append("article_content",s+"<hr>"+o),c.append("destination","medium"),c.append("keywords",d.toString());var u=new XMLHttpRequest;u.open("post","/export_data",!0),u.send(c),u.onload=function(){if(200!=u.status)swal(_("Error: ")+u.statusText+" - "+u.response);else{var e=JSON.parse(u.response);a.style.color="green",a.innerHTML=_("Published on ")+e.link}}}async function wordpress2(e,t){fd=new FormData;var n=document.querySelector('meta[name="article_id"]').content;fd.append("article_id",n),fd.append("destination","wp"),fd.append("wpcom_id",t),fd.append("wpcom_address",e),xhr=new XMLHttpRequest,xhr.open("post","/export_data",!0),xhr.send(fd),alarming(xhr,_("Published on ")+e)}async function wordpress_on_fly(e,t,n){var a=document.getElementById("msg");if("Article"==document.querySelector('meta[name="texttype"]').content.trim()){var r=getCookie("mur2_wpc_accesstoken"),o=getCookie("mur2_wpc_sideid");""===r&&swal(_("Error: You are not logged into Wordpress.com"));document.querySelector('meta[name="article_id"]').content;for(var l=n.getHtmlImg(),s=e.getHtmlImg(),i=t.getHtmlImg(),d=(document.getElementsByClassName("feature_image")[0],keywordlist()),c=[],u=d.length;u--;){let e=await new Promise(e=>{let t=new FormData,n=new XMLHttpRequest;t.append("name",d[u]),n.open("post","https://public-api.wordpress.com/wp/v2/sites/"+o+"/tags",!0),n.setRequestHeader("Authorization","Bearer "+decodeURIComponent(r)),n.onload=function(){e(n.response)},n.send(t)});var m=JSON.parse(e);"id"in m?c.push(m.id):"data"in m&&"term_id"in m.data&&c.push(m.data.term_id)}var p=new FormData;p.append("title",s),p.append("status","private"),p.append("content",i+"<hr>"+l),p.append("excerpt",i),p.append("format","standard"),p.append("tags",c);var w=new XMLHttpRequest;w.open("post","https://public-api.wordpress.com/wp/v2/sites/"+o+"/posts",!0),w.setRequestHeader("Authorization","Bearer "+decodeURIComponent(r)),w.send(p),w.onload=function(){if(201!=w.status)swal(_("Error: ")+w.statusText+" - "+w.response);else{var e=JSON.parse(w.response);a.style.color="green",a.innerHTML=_("Published on ")+e.link,wordpress2(e.link,e.id)}},200!=w.status?await sleep(5e3):await sleep(2e3),a.innerHTML=""}}async function render_on_server(){var e=document.getElementById("bibstyle_select").value;""===e&&(e="apa");var t=document.getElementById("bib-source").value,n=document.querySelector('meta[name="mur2language"]').content;console.log(g_selectedTextarea);var a=document.getElementById(g_selectedTextarea).value,r=document.querySelector('meta[name="endnotetext"]').content,o=new FormData;o.append("bib",t),o.append("md",a),o.append("bibsyle",e),o.append("language",n),o.append("footnote",r);var l=new XMLHttpRequest;l.responseType="blob",l.open("post","/processmarkdown",!0),l.send(o),l.onload=function(){var e=new FileReader,t=this.response;if(200!=l.status)e.addEventListener("loadend",function(e){swal(_("Error: ")+JSON.parse(e.srcElement.result).Error)});else{var n="article_"+g_selectedTextarea.split("-")[0];"article_abstact"===n&&(n="article_abstract_text"),e.addEventListener("loadend",function(e){g_domSetHighlightedContent(n,e.srcElement.result,"none")})}e.readAsText(t)}}async function make_export(e,t){var n=document.getElementById("title-source").value,a=document.getElementById("abstact-source").value,r=new Blob([t.getMdBackend()],{type:"text/markdown;charset=utf-8"}),o=document.querySelector('meta[name="endnotetext"]').content,l=document.querySelector('meta[name="mur2language"]').content,s=document.getElementById("bib-source").value,i=new FormData,d=document.getElementById("bibstyle_select").value;""===d&&(d="apa-6th-edition");var c=document.getElementById("msg");c.innerHTML=_("Working..."),c.style.color="green";var u=document.querySelector('meta[name="author"]').content;i.append("destination",e),i.append("mdfile",r,"article_text.md"),i.append("article_title",n),i.append("article_abstract",a),i.append("endnotetext",o),i.append("language",l),i.append("author",u),i.append("bib",s),i.append("bibsyle",d);var m=new XMLHttpRequest;m.responseType="blob",m.open("post","/export_data",!0),m.send(i),m.onload=function(){var t=this.response;if(200!=m.status){var a=new FileReader;a.addEventListener("loadend",function(e){swal(_("Error: ")+JSON.parse(e.srcElement.result).Error)}),a.readAsText(t)}else{window.URL=window.URL||window.webkitURL;var r=window.URL.createObjectURL(t);if("latex"===e||"epub"===e||"msw"===e){var o=document.createElement("a");o.href=window.URL.createObjectURL(t),n=n.replace(/\s/g,"_"),o.download="latex"===e?n+".tex":"msw"===e?n+".doc":n+".epub",o.style.display="none",document.body.appendChild(o),o.click(),delete o}else-1!=navigator.userAgent.indexOf("iPad")||-1!=navigator.userAgent.indexOf("Macintosh")?window.location.href=r:window.open(r)}},200!=m.status?(await sleep(5e3),c.innerHTML=""):c.innerHTML=""}async function generate_from_md(e,t){if("msw"===e)swal({text:_("We recommend downloading the PDF version and transform it with the Adobe online PDF->World tool. This will give you the best result if you use a lot of mathematical formula or complicated tables. However, we still happy to generate ourselves also, if you wish."),buttons:{here:{text:_("Generate here"),value:"here"},there:{text:_("I will do on Adobe"),value:"there"}}}).then(n=>{switch(n){case"there":window.open("https://www.adobe.com/uk/acrobat/online/pdf-to-word.html");break;case"here":make_export(e,t)}});else make_export(e,t)}function multiSearchKeyup(e){var t=!1,n=!1;if(e.classList.contains("fa-close")?n=!0:13===event.keyCode?t=!0:"\\n"==e.value.slice(-2)&&(t=!0),t){var a=e.value;"\\n"==e.value.slice(-2)&&(a=e.value.slice(0,-2)),e.parentNode.insertBefore(function(e){const t=document.createElement("div");t.setAttribute("class","multi-search-item");const n=`<span>${e}</span>`;return t.innerHTML=n+'<div class="fa fa-close" onclick="multiSearchKeyup(this)"></div>',t}(a),e),e.value="",childrenNumber=e.parentNode.getElementsByClassName("multi-search-item"),childrenNumber.length>=10&&(e.parentNode.getElementsByTagName("input")[0].style.display="none")}else n&&e.parentNode.remove()}function selectReviewedID(){var e=document.getElementById("reviewModal"),t=document.getElementById("modalCloseReview");e.getElementsByClassName("modal-body")[0].innerHTML='<iframe id="editor_iframe" allowTransparency="true" frameborder="0" scrolling="yes"  src="/search" type= "text/javascript"></iframe>',e.style.display="block",t.onclick=function(){var t=document.getElementById("editor_iframe").contentWindow.document.getElementById("selected");reviewdArticle=document.getElementById("reviewdArticle"),reviewdArticle.value=t.innerHTML,e.style.display="none"},window.onclick=function(t){t.target==e&&(e.style.display="none")}}function addNewAuthor(e,t){var n;document.getElementById("msg");n="remove"===e?t:document.getElementById("newauthor").value;var a=document.querySelector('meta[name="article_id"]').content;workshares=document.getElementsByClassName("workshare");let r=0;for(var o={},l=0;l<workshares.length;l++)""!==workshares[l].value&&("remove"===e?workshares[l].getAttribute("userid")!==t&&(r+=parseInt(workshares[l].value),parseInt(workshares[l].getAttribute("original"))!==parseInt(workshares[l].value)&&(o[workshares[l].getAttribute("userid")]=parseInt(workshares[l].value))):(r+=parseInt(workshares[l].value),parseInt(workshares[l].getAttribute("original"))!==parseInt(workshares[l].value)&&(o[workshares[l].getAttribute("userid")]=parseInt(workshares[l].value))));if(100!==r)swal(_("Error: The sum of the workshare is not 100!"));else{var s=new FormData;s.append("newauthor",n),s.append("articleid",a),s.append("action",e),s.append("workshare",JSON.stringify(o));var i=new XMLHttpRequest;i.open("post","/addauthor",!0),i.send(s),i.onload=function(){200!=i.status?swal(_("Error: ")+i.statusText+" - "+i.response):location.reload()}}}function getArticleversion(){document.getElementById("msg");var e=document.getElementById("id_rollback_article_list"),t=e.options[e.selectedIndex].value;t=t.split("_");var n=new FormData;n.append("version",t[0]),n.append("article",t[1]);var a=new XMLHttpRequest;a.open("post","/getarticleversions",!0),a.send(n),a.onload=function(){if(200!=a.status)swal(_("Error: ")+a.statusText+" - "+a.response);else{var e=JSON.parse(a.response);document.getElementById("title-source").value=e.title,document.getElementById("abstact-source").value=e.abstract,document.getElementById("main-source").value=e.main;var t=document.getElementById("main-source"),n=new Event("input");t.dispatchEvent(n)}}}