/**
 * TextareaDecorator.js
 * written by Colin Kuebler 2012
 * Updated by Roman Parpalak, 2015.
 * Part of LDT, dual licensed under GPLv3 and MIT
 * Builds and maintains a styled output layer under a textarea input layer
 * Updated by Sajó, Zsolt Attila, 2020 for mur2 editor
 */
function TextareaDecorator(e,t){var n,a=this;if("ldt-textarea"!==e.className){var l=document.createElement("div");(n=document.createElement("pre")).className="ldt-pre",l.appendChild(n);var r=document.createElement("label");r.className="ldt-label",l.appendChild(r),e.parentNode.replaceChild(l,e),r.appendChild(e),l.className="ldt "+e.className,e.className="ldt-textarea"}else n=e.parentNode.previousSibling;
/**
     * Composes token class.
     *
     * Tokens are grouped into blocks.
     * Also a token have its own type.
     *
     * @param blockClass  token block type
     * @param inlineClass token type
     * @returns {string}
     */
/**
     * Detect changes between a token and its DOM representation.
     *
     * @param newToken hash object
     * @param oldNode  DOM node converted from old hash object
     *
     * @returns {boolean}
     */
function i(e,t){if(e.token!==t.textContent)return!1;var n=t.className;if(n.slice(0,n.indexOf(" "))!==e.block)return!1;var a=t.getAttribute("data-line");return!a||a==e.line}
/**
     * Updates a DOM node by a token
     *
     * @param node
     * @param token
     * @param inlineClass
     */function s(e,t,n){e.textContent=e.innerText=t.token;var a=function(e,t){return e+" "+t}(t.block,n);t.line?(e.className=a+" block-start",e.setAttribute("data-line",t.line)):e.className=a}return a.input=e,a.output=n,a.recalcHeight=function(){a.input.style.height=Math.max(a.output.offsetHeight,100)+"px"},a.update=function(){var l=g_focusmode_switch,r=e.value;if(r)if(l){for(;n.firstChild;)n.removeChild(n.lastChild);for(var o=document.getElementById("main-source"),c=o.selectionStart,d=o.value.substring(0,c),u=o.value.substring(c),p=[".","!","!","?","\n","。"],f=1e7,h=-1,m=p.length;m--;){var v=u.indexOf(p[m]);-1!==v&&v<f&&(f=v);var g=d.lastIndexOf(p[m]);g>h&&(h=g)}h+=1,f+=1;var C=document.createElement("span");C.textContent=C.innerText=d.slice(0,h),C.className="notfocused",n.appendChild(C);var x=document.createElement("span");x.className="focused",x.textContent=x.innerText=d.slice(h,d.length)+u.slice(0,f),n.appendChild(x);var N=document.createElement("span");N.className="notfocused",N.textContent=N.innerText=u.slice(f,u.length),n.appendChild(N)}else{(function(e,t,n){var a=""!==e&&e.substring(e.length-1)||"";"\r"!=a&&"\n"!=a||(e+=" ");var l,r,o,c=t.childNodes,d=n.tokenize(e);for(l=0;l<d.length&&l<c.length&&i(d[l],c[l]);l++);for(;d.length<c.length;)t.removeChild(c[l]);for(r=d.length-1,o=c.length-1;l<o&&i(d[r],c[o]);r--,o--);for(;l<=o;l++){var u=d[l];s(c[l],u,n.identifyInline(u))}for(var p=c[l]||null;l<=r;l++){var f=document.createElement("span");s(f,u=d[l],n.identifyInline(u)),t.insertBefore(f,p)}})(r,n,t);a.recalcHeight()}else for(;n.firstChild;)n.removeChild(n.lastChild)},e.addEventListener?e.addEventListener("input",a.update,!1):e.attachEvent("onpropertychange",function(e){"value"===e.propertyName.toLowerCase()&&a.update()}),a.update(),a}