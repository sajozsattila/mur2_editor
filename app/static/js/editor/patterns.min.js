"use strict";const utils=require("./utils.js");function last(t){return t.slice(-1)[0]}module.exports=(t=>{const e=new RegExp("^ {0,3}[-*_]{3,} ?"+utils.escapeRegExp(t.leftDelimiter)+"[^"+utils.escapeRegExp(t.rightDelimiter)+"]");return[{name:"fenced code blocks",tests:[{shift:0,block:!0,info:utils.hasDelimiters("end",t)}],transform:(e,i)=>{let n=e[i],s=n.info.lastIndexOf(t.leftDelimiter),l=utils.getAttrs(n.info,s,t);utils.addAttrs(l,n),n.info=utils.removeDelimiter(n.info,t)}},{name:"inline nesting 0",tests:[{shift:0,type:"inline",children:[{shift:-1,type:t=>"image"===t||"code_inline"===t},{shift:0,type:"text",content:utils.hasDelimiters("start",t)}]}],transform:(e,i,n)=>{let s=e[i].children[n],l=s.content.indexOf(t.rightDelimiter),r=e[i].children[n-1],o=utils.getAttrs(s.content,0,t);utils.addAttrs(o,r),s.content.length===l+t.rightDelimiter.length?e[i].children.splice(n,1):s.content=s.content.slice(l+t.rightDelimiter.length)}},{name:"tables",tests:[{shift:0,type:"table_close"},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:utils.hasDelimiters("only",t)}],transform:(e,i)=>{let n=e[i+2],s=utils.getMatchingOpeningToken(e,i),l=utils.getAttrs(n.content,0,t);utils.addAttrs(l,s),e.splice(i+1,3)}},{name:"inline attributes",tests:[{shift:0,type:"inline",children:[{shift:-1,nesting:-1},{shift:0,type:"text",content:utils.hasDelimiters("start",t)}]}],transform:(e,i,n)=>{let s=e[i].children[n],l=s.content,r=utils.getAttrs(l,0,t),o=utils.getMatchingOpeningToken(e[i].children,n-1);utils.addAttrs(r,o),s.content=l.slice(l.indexOf(t.rightDelimiter)+t.rightDelimiter.length)}},{name:"list softbreak",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:utils.hasDelimiters("only",t)}]}],transform:(e,i,n)=>{let s=e[i].children[n].content,l=utils.getAttrs(s,0,t),r=i-2;for(;e[r-1]&&"ordered_list_open"!==e[r-1].type&&"bullet_list_open"!==e[r-1].type;)r--;utils.addAttrs(l,e[r-1]),e[i].children=e[i].children.slice(0,-2)}},{name:"list double softbreak",tests:[{shift:0,type:t=>"bullet_list_close"===t||"ordered_list_close"===t},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:utils.hasDelimiters("only",t),children:t=>1===t.length},{shift:3,type:"paragraph_close"}],transform:(e,i)=>{let n=e[i+2].content,s=utils.getAttrs(n,0,t),l=utils.getMatchingOpeningToken(e,i);utils.addAttrs(s,l),e.splice(i+1,3)}},{name:"list item end",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-1,type:"text",content:utils.hasDelimiters("end",t)}]}],transform:(e,i,n)=>{let s=e[i].children[n],l=s.content,r=utils.getAttrs(l,l.lastIndexOf(t.leftDelimiter),t);utils.addAttrs(r,e[i-2]);let o=l.slice(0,l.lastIndexOf(t.leftDelimiter));s.content=" "!==last(o)?o:o.slice(0,-1)}},{name:"\n{.a} softbreak then curly in start",tests:[{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:utils.hasDelimiters("only",t)}]}],transform:(e,i,n)=>{let s=e[i].children[n],l=utils.getAttrs(s.content,0,t),r=i+1;for(;e[r+1]&&-1===e[r+1].nesting;)r++;let o=utils.getMatchingOpeningToken(e,r);utils.addAttrs(l,o),e[i].children=e[i].children.slice(0,-2)}},{name:"horizontal rule",tests:[{shift:0,type:"paragraph_open"},{shift:1,type:"inline",children:t=>1===t.length,content:t=>null!==t.match(e)},{shift:2,type:"paragraph_close"}],transform:(e,i)=>{let n=e[i];n.type="hr",n.tag="hr",n.nesting=0;let s=e[i+1].content,l=s.lastIndexOf(t.leftDelimiter);n.attrs=utils.getAttrs(s,l,t),n.markup=s,e.splice(i+1,2)}},{name:"end of block",tests:[{shift:0,type:"inline",children:[{position:-1,content:utils.hasDelimiters("end",t),type:t=>"code_inline"!==t}]}],transform:(e,i,n)=>{let s=e[i].children[n],l=s.content,r=utils.getAttrs(l,l.lastIndexOf(t.leftDelimiter),t),o=i+1;for(;e[o+1]&&-1===e[o+1].nesting;)o++;let a=utils.getMatchingOpeningToken(e,o);utils.addAttrs(r,a);let c=l.slice(0,l.lastIndexOf(t.leftDelimiter));s.content=" "!==last(c)?c:c.slice(0,-1)}}]});